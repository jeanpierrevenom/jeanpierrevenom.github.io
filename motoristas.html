<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransLog - Motoristas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            display: none;
            opacity: 0;
        }
        .modal.flex {
            display: flex;
            opacity: 1;
        }
        table tr:hover {
            background-color: #f9fafb;
        }
        .error-input {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .success-input {
            border-color: #10b981 !important;
        }
        .warning-input {
            border-color: #f59e0b !important;
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">Motoristas</h3>
                <button onclick="abrirModalMotorista()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Novo Motorista
                </button>
            </div>
            
            <!-- Busca -->
            <div class="mt-4">
                <input type="text" id="buscaMotoristas" placeholder="Buscar motorista por nome, CPF ou CNH..." 
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                    onkeyup="buscarMotoristas()">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CPF</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CNH</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Validade CNH</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody id="tabelaMotoristas" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Motorista -->
    <div id="modalMotorista" class="modal hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="modalTitulo">Novo Motorista</h3>
                <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="formMotorista" onsubmit="salvarMotorista(event)">
                <input type="hidden" id="motoristaId">
                
                <!-- Dados Pessoais -->
                <h4 class="font-medium mb-3 text-gray-700 border-b pb-2">Dados Pessoais</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo*</label>
                        <input type="text" id="motoristaNome" required maxlength="100" 
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CPF*</label>
                        <input type="text" id="motoristaCpf" required maxlength="14" 
                            onkeyup="mascaraCPF(this)" onblur="validarCPF()"
                            placeholder="000.000.000-00"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <div id="cpfError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">RG</label>
                        <input type="text" id="motoristaRg" maxlength="20" 
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Nascimento</label>
                        <input type="date" id="motoristaDataNasc" maxlength="10"
                            onchange="calcularIdade()"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <div id="idadeDisplay" class="text-xs text-gray-500 mt-1"></div>
                    </div>
                </div>

                <!-- Dados da CNH -->
                <h4 class="font-medium mb-3 text-gray-700 border-b pb-2">HabilitaÃ§Ã£o (CNH)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NÃºmero da CNH*</label>
                        <input type="text" id="motoristaCnh" required maxlength="20" 
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria CNH</label>
                        <select id="motoristaCategoria" class="w-full px-3 py-2 border rounded-lg">
                            <option value="A">A - Motocicleta</option>
                            <option value="B">B - Carro</option>
                            <option value="C">C - CaminhÃ£o (acima de 3,5t)</option>
                            <option value="D">D - Ã”nibus (acima de 8 passageiros)</option>
                            <option value="E" selected>E - CombinaÃ§Ã£o de veÃ­culos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Validade CNH*</label>
                        <input type="date" id="motoristaValidadeCnh" required 
                            onchange="verificarValidadeCNH()"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <div id="validadeWarning" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Primeira HabilitaÃ§Ã£o</label>
                        <input type="date" id="motoristaPrimeiraCnh" 
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <!-- Contato -->
                <h4 class="font-medium mb-3 text-gray-700 border-b pb-2">Contato</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="text" id="motoristaTelefone" maxlength="15" onkeyup="mascaraTelefone(this)"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="motoristaEmail" maxlength="100" 
                            onblur="validarEmail()"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <div id="emailError" class="error-message hidden"></div>
                    </div>
                </div>

                <!-- EndereÃ§o -->
                <h4 class="font-medium mb-3 text-gray-700 border-b pb-2">EndereÃ§o</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CEP</label>
                        <div class="flex space-x-2">
                            <input type="text" id="motoristaCep" maxlength="9" onkeyup="mascaraCep(this)" 
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <button type="button" onclick="buscarCep()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="cepError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">EndereÃ§o</label>
                        <input type="text" id="motoristaEndereco" maxlength="200" readonly
                            class="w-full px-3 py-2 border rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NÃºmero</label>
                        <input type="text" id="motoristaNumero" maxlength="10"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                        <input type="text" id="motoristaComplemento" maxlength="100"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                        <input type="text" id="motoristaBairro" maxlength="100" readonly
                            class="w-full px-3 py-2 border rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                        <input type="text" id="motoristaCidade" maxlength="100" readonly
                            class="w-full px-3 py-2 border rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">UF</label>
                        <input type="text" id="motoristaUf" maxlength="2" readonly
                            class="w-full px-3 py-2 border rounded-lg bg-gray-50">
                    </div>
                </div>

                <!-- InformaÃ§Ãµes Profissionais -->
                <h4 class="font-medium mb-3 text-gray-700 border-b pb-2">InformaÃ§Ãµes Profissionais</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">MatrÃ­cula</label>
                        <input type="text" id="motoristaMatricula" maxlength="20"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data AdmissÃ£o</label>
                        <input type="date" id="motoristaDataAdmissao"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="motoristaStatus" class="w-full px-3 py-2 border rounded-lg">
                            <option value="disponÃ­vel">ðŸŸ¢ DisponÃ­vel</option>
                            <option value="em viagem">ðŸ”µ Em Viagem</option>
                            <option value="descanso">ðŸŸ¡ Descanso</option>
                            <option value="fÃ©rias">ðŸŸ  FÃ©rias</option>
                            <option value="inativo">âš« Inativo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de VÃ­nculo</label>
                        <select id="motoristaVinculo" class="w-full px-3 py-2 border rounded-lg">
                            <option value="clt">CLT</option>
                            <option value="pj">Pessoa JurÃ­dica</option>
                            <option value="autonomo">AutÃ´nomo</option>
                            <option value="terceirizado">Terceirizado</option>
                        </select>
                    </div>
                </div>

                <!-- ObservaÃ§Ãµes -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ObservaÃ§Ãµes</label>
                    <textarea id="motoristaObservacoes" rows="3" maxlength="500" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- BotÃµes -->
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="fecharModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btnSalvar" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dados iniciais
        let motoristas = JSON.parse(localStorage.getItem('motoristas')) || [
            { id: 1, nome: 'JoÃ£o da Silva', cpf: '123.456.789-00', rg: '12.345.678-9', cnh: '01234567890', categoria: 'E', validade_cnh: '2025-12-31', telefone: '(11) 98765-4321', email: 'joao.silva@email.com', cidade: 'SÃ£o Paulo', uf: 'SP', status: 'disponÃ­vel' },
            { id: 2, nome: 'Maria Santos', cpf: '234.567.890-11', rg: '23.456.789-0', cnh: '12345678901', categoria: 'D', validade_cnh: '2024-10-15', telefone: '(11) 97654-3210', email: 'maria.santos@email.com', cidade: 'Guarulhos', uf: 'SP', status: 'em viagem' },
            { id: 3, nome: 'Pedro Oliveira', cpf: '345.678.901-22', rg: '34.567.890-1', cnh: '23456789012', categoria: 'E', validade_cnh: '2025-05-20', telefone: '(21) 96543-2109', email: 'pedro.oliveira@email.com', cidade: 'Rio de Janeiro', uf: 'RJ', status: 'disponÃ­vel' }
        ];

        if (!localStorage.getItem('motoristas')) {
            localStorage.setItem('motoristas', JSON.stringify(motoristas));
        }

        document.addEventListener('DOMContentLoaded', function() {
            carregarTabela();
        });

        function carregarTabela() {
            motoristas = JSON.parse(localStorage.getItem('motoristas')) || [];
            const tbody = document.getElementById('tabelaMotoristas');
            
            if (motoristas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhum motorista cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = motoristas.map(m => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${m.id}</td>
                    <td class="px-6 py-4">${m.nome}</td>
                    <td class="px-6 py-4">${m.cpf}</td>
                    <td class="px-6 py-4">${m.cnh}</td>
                    <td class="px-6 py-4">${m.categoria}</td>
                    <td class="px-6 py-4">
                        <span class="${m.validade_cnh && new Date(m.validade_cnh) < new Date() ? 'text-red-600 font-bold' : ''}">
                            ${m.validade_cnh ? new Date(m.validade_cnh).toLocaleDateString('pt-BR') : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4">${m.telefone || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full 
                            ${m.status === 'disponÃ­vel' ? 'bg-green-100 text-green-800' : 
                              m.status === 'em viagem' ? 'bg-blue-100 text-blue-800' : 
                              m.status === 'descanso' ? 'bg-yellow-100 text-yellow-800' : 
                              m.status === 'fÃ©rias' ? 'bg-orange-100 text-orange-800' : 
                              'bg-gray-100 text-gray-800'}">
                            ${m.status === 'disponÃ­vel' ? 'ðŸŸ¢' : 
                              m.status === 'em viagem' ? 'ðŸ”µ' : 
                              m.status === 'descanso' ? 'ðŸŸ¡' : 
                              m.status === 'fÃ©rias' ? 'ðŸŸ ' : 'âš«'} ${m.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editarMotorista(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="excluirMotorista(${m.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function buscarMotoristas() {
            const termo = document.getElementById('buscaMotoristas').value.toLowerCase();
            const motoristas = JSON.parse(localStorage.getItem('motoristas')) || [];
            
            const resultados = motoristas.filter(m => 
                m.nome.toLowerCase().includes(termo) ||
                (m.cpf && m.cpf.toLowerCase().includes(termo)) ||
                (m.cnh && m.cnh.toLowerCase().includes(termo))
            );
            
            const tbody = document.getElementById('tabelaMotoristas');
            if (resultados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhum motorista encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = resultados.map(m => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${m.id}</td>
                    <td class="px-6 py-4">${m.nome}</td>
                    <td class="px-6 py-4">${m.cpf}</td>
                    <td class="px-6 py-4">${m.cnh}</td>
                    <td class="px-6 py-4">${m.categoria}</td>
                    <td class="px-6 py-4">
                        <span class="${m.validade_cnh && new Date(m.validade_cnh) < new Date() ? 'text-red-600 font-bold' : ''}">
                            ${m.validade_cnh ? new Date(m.validade_cnh).toLocaleDateString('pt-BR') : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4">${m.telefone || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full 
                            ${m.status === 'disponÃ­vel' ? 'bg-green-100 text-green-800' : 
                              m.status === 'em viagem' ? 'bg-blue-100 text-blue-800' : 
                              m.status === 'descanso' ? 'bg-yellow-100 text-yellow-800' : 
                              m.status === 'fÃ©rias' ? 'bg-orange-100 text-orange-800' : 
                              'bg-gray-100 text-gray-800'}">
                            ${m.status === 'disponÃ­vel' ? 'ðŸŸ¢' : 
                              m.status === 'em viagem' ? 'ðŸ”µ' : 
                              m.status === 'descanso' ? 'ðŸŸ¡' : 
                              m.status === 'fÃ©rias' ? 'ðŸŸ ' : 'âš«'} ${m.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editarMotorista(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="excluirMotorista(${m.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // FunÃ§Ãµes de MÃ¡scara
        function mascaraCPF(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            input.value = valor;
        }

        function mascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 10) {
                valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
                valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
                valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
            }
            input.value = valor;
        }

        function mascaraCep(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length > 5) {
                valor = valor.replace(/^(\d{5})(\d)/, '$1-$2');
            }
            input.value = valor;
        }

        // FunÃ§Ãµes de ValidaÃ§Ã£o
        function validarCPF() {
            const input = document.getElementById('motoristaCpf');
            const errorDiv = document.getElementById('cpfError');
            const valor = input.value.replace(/\D/g, '');
            
            if (valor.length !== 11) {
                errorDiv.textContent = 'CPF deve ter 11 dÃ­gitos';
                input.classList.add('error-input');
                errorDiv.classList.remove('hidden');
                return false;
            }
            
            if (!validarCPFNumero(valor)) {
                errorDiv.textContent = 'CPF invÃ¡lido';
                input.classList.add('error-input');
                errorDiv.classList.remove('hidden');
                return false;
            }
            
            input.classList.remove('error-input');
            input.classList.add('success-input');
            errorDiv.classList.add('hidden');
            return true;
        }

        function validarCPFNumero(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11) return false;
            
            // Elimina CPFs invÃ¡lidos conhecidos
            if (/^(\d)\1+$/.test(cpf)) return false;
            
            // Valida 1Âº dÃ­gito
            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let resto = 11 - (soma % 11);
            let dig1 = (resto === 10 || resto === 11) ? 0 : resto;
            if (dig1 !== parseInt(cpf.charAt(9))) return false;
            
            // Valida 2Âº dÃ­gito
            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            resto = 11 - (soma % 11);
            let dig2 = (resto === 10 || resto === 11) ? 0 : resto;
            return dig2 === parseInt(cpf.charAt(10));
        }

        function validarEmail() {
            const email = document.getElementById('motoristaEmail').value;
            const errorDiv = document.getElementById('emailError');
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !regex.test(email)) {
                document.getElementById('motoristaEmail').classList.add('error-input');
                errorDiv.textContent = 'Email invÃ¡lido';
                errorDiv.classList.remove('hidden');
                return false;
            } else if (email) {
                document.getElementById('motoristaEmail').classList.remove('error-input');
                document.getElementById('motoristaEmail').classList.add('success-input');
                errorDiv.classList.add('hidden');
                return true;
            }
            return true;
        }

        function verificarValidadeCNH() {
            const validade = new Date(document.getElementById('motoristaValidadeCnh').value);
            const hoje = new Date();
            const warningDiv = document.getElementById('validadeWarning');
            
            if (validade < hoje) {
                warningDiv.textContent = 'âš ï¸ ATENÃ‡ÃƒO: CNH vencida!';
                warningDiv.classList.remove('hidden');
                document.getElementById('motoristaValidadeCnh').classList.add('warning-input');
            } else {
                const diasRestantes = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
                if (diasRestantes <= 30) {
                    warningDiv.textContent = `âš ï¸ CNH vence em ${diasRestantes} dias. Providenciar renovaÃ§Ã£o.`;
                    warningDiv.classList.remove('hidden');
                    document.getElementById('motoristaValidadeCnh').classList.add('warning-input');
                } else {
                    warningDiv.classList.add('hidden');
                    document.getElementById('motoristaValidadeCnh').classList.remove('warning-input');
                }
            }
        }

        function calcularIdade() {
            const dataNasc = document.getElementById('motoristaDataNasc').value;
            if (dataNasc) {
                const hoje = new Date();
                const nasc = new Date(dataNasc);
                let idade = hoje.getFullYear() - nasc.getFullYear();
                const mes = hoje.getMonth() - nasc.getMonth();
                if (mes < 0 || (mes === 0 && hoje.getDate() < nasc.getDate())) {
                    idade--;
                }
                document.getElementById('idadeDisplay').textContent = `${idade} anos`;
            }
        }

        // FunÃ§Ã£o de busca de CEP
        function buscarCep() {
            const cep = document.getElementById('motoristaCep').value.replace(/\D/g, '');
            const cepError = document.getElementById('cepError');
            
            if (cep.length !== 8) {
                cepError.textContent = 'CEP deve ter 8 dÃ­gitos';
                cepError.classList.remove('hidden');
                return;
            }
            
            // Mostrar loading
            document.getElementById('motoristaEndereco').value = 'Buscando...';
            document.getElementById('motoristaCidade').value = '...';
            document.getElementById('motoristaUf').value = '...';
            document.getElementById('motoristaBairro').value = '...';
            
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (data.erro) {
                        throw new Error('CEP nÃ£o encontrado');
                    }
                    
                    document.getElementById('motoristaEndereco').value = data.logradouro || '';
                    document.getElementById('motoristaCidade').value = data.localidade || '';
                    document.getElementById('motoristaUf').value = data.uf || '';
                    document.getElementById('motoristaBairro').value = data.bairro || '';
                    
                    cepError.classList.add('hidden');
                    document.getElementById('motoristaCep').classList.add('success-input');
                })
                .catch(error => {
                    document.getElementById('motoristaEndereco').value = '';
                    document.getElementById('motoristaCidade').value = '';
                    document.getElementById('motoristaUf').value = '';
                    document.getElementById('motoristaBairro').value = '';
                    
                    cepError.textContent = 'Erro ao buscar CEP: ' + error.message;
                    cepError.classList.remove('hidden');
                    document.getElementById('motoristaCep').classList.add('error-input');
                });
        }

        function abrirModalMotorista(id = null) {
            document.getElementById('formMotorista').reset();
            document.getElementById('motoristaId').value = '';
            document.getElementById('modalTitulo').textContent = 'Novo Motorista';
            
            // Limpar campos
            document.getElementById('motoristaEndereco').value = '';
            document.getElementById('motoristaCidade').value = '';
            document.getElementById('motoristaUf').value = '';
            document.getElementById('motoristaBairro').value = '';
            document.getElementById('idadeDisplay').textContent = '';
            
            // Limpar classes de validaÃ§Ã£o
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('error-input', 'success-input', 'warning-input');
            });
            
            if (id) {
                const motoristas = JSON.parse(localStorage.getItem('motoristas')) || [];
                const motorista = motoristas.find(m => m.id === id);
                if (motorista) {
                    document.getElementById('modalTitulo').textContent = 'Editar Motorista';
                    document.getElementById('motoristaId').value = motorista.id;
                    document.getElementById('motoristaNome').value = motorista.nome || '';
                    document.getElementById('motoristaCpf').value = motorista.cpf || '';
                    document.getElementById('motoristaRg').value = motorista.rg || '';
                    document.getElementById('motoristaCnh').value = motorista.cnh || '';
                    document.getElementById('motoristaCategoria').value = motorista.categoria || 'E';
                    document.getElementById('motoristaValidadeCnh').value = motorista.validade_cnh || '';
                    document.getElementById('motoristaDataNasc').value = motorista.data_nasc || '';
                    document.getElementById('motoristaTelefone').value = motorista.telefone || '';
                    document.getElementById('motoristaEmail').value = motorista.email || '';
                    document.getElementById('motoristaCep').value = motorista.cep || '';
                    document.getElementById('motoristaEndereco').value = motorista.endereco || '';
                    document.getElementById('motoristaNumero').value = motorista.numero || '';
                    document.getElementById('motoristaComplemento').value = motorista.complemento || '';
                    document.getElementById('motoristaBairro').value = motorista.bairro || '';
                    document.getElementById('motoristaCidade').value = motorista.cidade || '';
                    document.getElementById('motoristaUf').value = motorista.uf || '';
                    document.getElementById('motoristaMatricula').value = motorista.matricula || '';
                    document.getElementById('motoristaDataAdmissao').value = motorista.data_admissao || '';
                    document.getElementById('motoristaVinculo').value = motorista.vinculo || 'clt';
                    document.getElementById('motoristaStatus').value = motorista.status || 'disponÃ­vel';
                    document.getElementById('motoristaObservacoes').value = motorista.observacoes || '';
                    
                    calcularIdade();
                    verificarValidadeCNH();
                }
            }
            
            document.getElementById('modalMotorista').classList.remove('hidden');
            document.getElementById('modalMotorista').classList.add('flex');
        }

        function fecharModal() {
            document.getElementById('modalMotorista').classList.add('hidden');
            document.getElementById('modalMotorista').classList.remove('flex');
        }

        function salvarMotorista(event) {
            event.preventDefault();
            
            // Validar campos obrigatÃ³rios
            if (!validarCPF()) {
                alert('Por favor, corrija o CPF antes de salvar.');
                return;
            }
            
            if (!validarEmail()) {
                alert('Por favor, corrija o email antes de salvar.');
                return;
            }
            
            const motoristas = JSON.parse(localStorage.getItem('motoristas')) || [];
            const id = document.getElementById('motoristaId').value;
            
            const motoristaData = {
                nome: document.getElementById('motoristaNome').value,
                cpf: document.getElementById('motoristaCpf').value,
                rg: document.getElementById('motoristaRg').value,
                cnh: document.getElementById('motoristaCnh').value,
                categoria: document.getElementById('motoristaCategoria').value,
                validade_cnh: document.getElementById('motoristaValidadeCnh').value,
                data_nasc: document.getElementById('motoristaDataNasc').value,
                telefone: document.getElementById('motoristaTelefone').value,
                email: document.getElementById('motoristaEmail').value,
                cep: document.getElementById('motoristaCep').value,
                endereco: document.getElementById('motoristaEndereco').value,
                numero: document.getElementById('motoristaNumero').value,
                complemento: document.getElementById('motoristaComplemento').value,
                bairro: document.getElementById('motoristaBairro').value,
                cidade: document.getElementById('motoristaCidade').value,
                uf: document.getElementById('motoristaUf').value,
                matricula: document.getElementById('motoristaMatricula').value,
                data_admissao: document.getElementById('motoristaDataAdmissao').value,
                vinculo: document.getElementById('motoristaVinculo').value,
                status: document.getElementById('motoristaStatus').value,
                observacoes: document.getElementById('motoristaObservacoes').value
            };

            if (id) {
                // Editar
                const index = motoristas.findIndex(m => m.id == id);
                if (index !== -1) {
                    const oldData = {...motoristas[index]};
                    motoristas[index] = { ...motoristas[index], ...motoristaData };
                    localStorage.setItem('motoristas', JSON.stringify(motoristas));
                    
                    window.parent.postMessage({
                        type: 'logModificacao',
                        data: {
                            tabela: 'motoristas',
                            operacao: 'UPDATE',
                            registro_id: id,
                            dados_anteriores: oldData,
                            dados_novos: motoristas[index]
                        }
                    }, '*');
                    
                    alert('Motorista atualizado com sucesso!');
                }
            } else {
                // Novo
                const novoId = motoristas.length > 0 ? Math.max(...motoristas.map(m => m.id)) + 1 : 1;
                const novoMotorista = { id: novoId, ...motoristaData };
                motoristas.push(novoMotorista);
                localStorage.setItem('motoristas', JSON.stringify(motoristas));
                
                window.parent.postMessage({
                    type: 'logModificacao',
                    data: {
                        tabela: 'motoristas',
                        operacao: 'INSERT',
                        registro_id: novoId,
                        dados_anteriores: null,
                        dados_novos: novoMotorista
                    }
                }, '*');
                
                alert('Motorista salvo com sucesso!');
            }

            fecharModal();
            carregarTabela();
        }

        function editarMotorista(id) {
            abrirModalMotorista(id);
        }

        function excluirMotorista(id) {
            if (confirm('Deseja realmente excluir este motorista?')) {
                const motoristas = JSON.parse(localStorage.getItem('motoristas')) || [];
                const motorista = motoristas.find(m => m.id === id);
                const novosMotoristas = motoristas.filter(m => m.id !== id);
                localStorage.setItem('motoristas', JSON.stringify(novosMotoristas));
                
                window.parent.postMessage({
                    type: 'logModificacao',
                    data: {
                        tabela: 'motoristas',
                        operacao: 'DELETE',
                        registro_id: id,
                        dados_anteriores: motorista,
                        dados_novos: null
                    }
                }, '*');
                
                alert('Motorista excluÃ­do com sucesso!');
                carregarTabela();
            }
        }
    </script>
</body>
</html>